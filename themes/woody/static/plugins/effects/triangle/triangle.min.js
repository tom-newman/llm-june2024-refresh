var ww=window.innerWidth,wh=window.innerHeight;function Tunnel(){this.init(),this.createMesh(),this.handleEvents(),window.requestAnimationFrame(this.render.bind(this))}function hslToRgb(e,t,i){var s,o,n;if(0==t)s=o=n=i;else{var r=function(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e},h=i<.5?i*(1+t):i+t-i*t,a=2*i-h;s=r(a,h,e+1/3),o=r(a,h,e),n=r(a,h,e-1/3)}return[.01*Math.round(100*s),.01*Math.round(100*o),.01*Math.round(100*n)]}Tunnel.prototype.init=function(){this.speed=4,this.mouse={position:new THREE.Vector2(.5*ww,.5*wh),ratio:new THREE.Vector2(0,0),target:new THREE.Vector2(.5*ww,.5*wh)},this.renderer=new THREE.WebGLRenderer({antialias:!0,canvas:document.querySelector(".triangle")}),this.renderer.setSize(ww,wh),this.camera=new THREE.PerspectiveCamera(15,ww/wh,.01,10),this.camera.rotation.y=Math.PI,this.camera.position.z=.4,this.scene=new THREE.Scene,this.scene.fog=new THREE.Fog(16777215,1,1.9)},Tunnel.prototype.createMesh=function(){var e=[],t=0,i=new THREE.Geometry;for(this.scene.remove(this.tubeMesh),t=0;t<5;t+=1)e.push(new THREE.Vector3(0,0,t/4*3));e[4].y=-.06,this.curve=new THREE.CatmullRomCurve3(e),this.curve.type="catmullrom",(i=new THREE.Geometry).vertices=this.curve.getPoints(120),this.splineMesh=new THREE.Line(i,new THREE.LineBasicMaterial),this.tubeMaterial=new THREE.MeshBasicMaterial({side:THREE.BackSide,vertexColors:THREE.FaceColors}),this.tubeGeometry=new THREE.TubeGeometry(this.curve,120,.02,3,!1);for(t=0;t<this.tubeGeometry.faces.length;t++)f=this.tubeGeometry.faces[t],p=this.tubeGeometry.vertices[f.a],color=new THREE.Color("hsl("+(.01*Math.floor(80*Math.abs(noise.simplex3(2*p.x,4*p.y,2*p.z))*100)+180)+",70%,60%)"),f.color=color;this.tubeGeometry_o=this.tubeGeometry.clone(),this.tubeMesh=new THREE.Mesh(this.tubeGeometry,this.tubeMaterial),this.scene.add(this.tubeMesh)},Tunnel.prototype.handleEvents=function(){window.addEventListener("resize",this.onResize.bind(this),!1),document.body.addEventListener("mousemove",this.onMouseMove.bind(this),!1)},Tunnel.prototype.onResize=function(){ww=window.innerWidth,wh=window.innerHeight,this.camera.aspect=ww/wh,this.camera.updateProjectionMatrix(),this.renderer.setSize(ww,wh)},Tunnel.prototype.onMouseMove=function(e){this.mouse.target.x=e.clientX,this.mouse.target.y=e.clientY},Tunnel.prototype.update=function(){this.createMesh()},Tunnel.prototype.updateCameraPosition=function(){this.mouse.position.x+=(this.mouse.target.x-this.mouse.position.x)/30,this.mouse.position.y+=(this.mouse.target.y-this.mouse.position.y)/30,this.mouse.ratio.x=this.mouse.position.x/ww,this.mouse.ratio.y=this.mouse.position.y/wh,this.camera.rotation.y=Math.PI-(.1*this.mouse.ratio.x-.05),this.camera.position.x=.008*this.mouse.ratio.x-.004,this.camera.position.y=.008*this.mouse.ratio.y-.004},Tunnel.prototype.updateCurve=function(e){var t,i,s,o=0,n=0,r=null,h=null;for(o=0;o<this.tubeGeometry.vertices.length;o+=1)r=this.tubeGeometry_o.vertices[o],h=this.tubeGeometry.vertices[o],n=Math.floor(o/120),h.x+=(r.x+this.splineMesh.geometry.vertices[n].x-h.x)/15,h.y+=(r.y+this.splineMesh.geometry.vertices[n].y-h.y)/15,h.applyAxisAngle(new THREE.Vector3(0,0,1),.1*Math.abs(Math.cos(.001*e+5*h.z)));this.tubeGeometry.verticesNeedUpdate=!0,this.curve.points[2].x=100*(1-this.mouse.ratio.x)-50,this.curve.points[4].x=100*(1-this.mouse.ratio.x)-50,this.curve.points[2].y=100*(1-this.mouse.ratio.y)-50,this.curve.points[4].y=100*(1-this.mouse.ratio.y)-50,this.splineMesh.geometry.verticesNeedUpdate=!0,this.splineMesh.geometry.vertices=this.curve.getPoints(120),e*=3e-4;for(o=0;o<this.tubeGeometry.faces.length;o++)t=this.tubeGeometry.faces[o],i=this.tubeGeometry.vertices[t.a],s=hslToRgb((.01*Math.floor(80*Math.abs(noise.simplex3(2*i.x,4*i.y,2*i.z+e))*100)+180)/360,.7,.6),color=new THREE.Color(s[0],s[1],s[2]),t.color=color;this.tubeGeometry.elementsNeedUpdate=!0},Tunnel.prototype.render=function(e){this.updateCameraPosition(),this.updateCurve(e),this.renderer.render(this.scene,this.camera),window.requestAnimationFrame(this.render.bind(this))},window.onload=function(){window.tunnel=new Tunnel};